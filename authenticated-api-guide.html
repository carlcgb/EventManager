<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Guide API Authentifi√©e - Booking.samhebert.ca</title>
        <style>
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                margin: 0;
                padding: 20px;
                background-color: #f5f5f5;
                line-height: 1.6;
            }
            .container {
                max-width: 1000px;
                margin: 0 auto;
                background: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .method {
                margin-bottom: 40px;
                padding: 25px;
                border: 1px solid #ddd;
                border-radius: 8px;
                background: #fafafa;
            }
            .method h3 {
                margin-top: 0;
                color: #2563eb;
                border-bottom: 2px solid #e5e7eb;
                padding-bottom: 10px;
            }
            .code-block {
                background: #1f2937;
                color: #f9fafb;
                border-radius: 6px;
                padding: 20px;
                margin: 15px 0;
                overflow-x: auto;
                font-family: "Courier New", monospace;
                font-size: 14px;
            }
            .highlight {
                background: #fef3c7;
                padding: 15px;
                border-left: 4px solid #f59e0b;
                margin: 15px 0;
            }
            .warning {
                background: #fee2e2;
                padding: 15px;
                border-left: 4px solid #ef4444;
                margin: 15px 0;
            }
            .success {
                background: #d1fae5;
                padding: 15px;
                border-left: 4px solid #10b981;
                margin: 15px 0;
            }
            .api-endpoint {
                background: #e0f2fe;
                padding: 10px;
                border-radius: 4px;
                font-family: monospace;
                margin: 10px 0;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
            }
            th,
            td {
                border: 1px solid #ddd;
                padding: 12px;
                text-align: left;
            }
            th {
                background-color: #f8f9fa;
                font-weight: bold;
            }
            .status-public {
                color: #10b981;
                font-weight: bold;
            }
            .status-private {
                color: #ef4444;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üîê Guide API Authentifi√©e - Booking.samhebert.ca</h1>
            <p>
                Ce guide explique comment acc√©der aux API prot√©g√©es qui
                n√©cessitent une authentification.
            </p>

            <div class="highlight">
                <strong>üîë Syst√®me d'authentification:</strong> Votre
                application utilise une authentification hybride avec sessions +
                Firebase Auth tokens.
            </div>

            <h2>üìã Liste des Endpoints API</h2>
            <table>
                <thead>
                    <tr>
                        <th>Endpoint</th>
                        <th>M√©thode</th>
                        <th>Acc√®s</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>/api/public/events</code></td>
                        <td>GET</td>
                        <td><span class="status-public">Public</span></td>
                        <td>√âv√©nements publi√©s (sans authentification)</td>
                    </tr>
                    <tr>
                        <td><code>/api/events</code></td>
                        <td>GET</td>
                        <td><span class="status-private">Priv√©</span></td>
                        <td>Tous les √©v√©nements de l'utilisateur connect√©</td>
                    </tr>
                    <tr>
                        <td><code>/api/events/stats</code></td>
                        <td>GET</td>
                        <td><span class="status-private">Priv√©</span></td>
                        <td>Statistiques des √©v√©nements</td>
                    </tr>
                    <tr>
                        <td><code>/api/events</code></td>
                        <td>POST</td>
                        <td><span class="status-private">Priv√©</span></td>
                        <td>Cr√©er un nouvel √©v√©nement</td>
                    </tr>
                    <tr>
                        <td><code>/api/auth/user</code></td>
                        <td>GET</td>
                        <td><span class="status-private">Priv√©</span></td>
                        <td>Informations de l'utilisateur connect√©</td>
                    </tr>
                    <tr>
                        <td><code>/api/calendar-integrations</code></td>
                        <td>GET</td>
                        <td><span class="status-private">Priv√©</span></td>
                        <td>Int√©grations calendrier de l'utilisateur</td>
                    </tr>
                </tbody>
            </table>

            <div class="method">
                <h3>üåê M√©thode 1: Depuis le Frontend React (Recommand√©e)</h3>
                <p>
                    Si vous d√©veloppez dans le m√™me projet React, utilisez les
                    hooks et utilitaires fournis:
                </p>

                <h4>Avec useQuery (lecture de donn√©es):</h4>
                <div class="code-block">
                    import { useQuery } from "@tanstack/react-query"; import {
                    useAuth } from "@/hooks/useAuth"; function MonComposant() {
                    const { isAuthenticated } = useAuth(); const { data: events,
                    isLoading } = useQuery({ queryKey: ["/api/events"], enabled:
                    isAuthenticated, // Ne lance la requ√™te que si connect√© });
                    if (isLoading) return &lt;div&gt;Chargement...&lt;/div&gt;;
                    return ( &lt;div&gt; {events?.map(event =&gt; ( &lt;div
                    key={event.id}&gt;{event.title}&lt;/div&gt; ))} &lt;/div&gt;
                    ); }
                </div>

                <h4>Avec useMutation (modifications de donn√©es):</h4>
                <div class="code-block">
                    import { useMutation, useQueryClient } from
                    "@tanstack/react-query"; import { apiRequest } from
                    "@/lib/queryClient"; function CreerEvenement() { const
                    queryClient = useQueryClient(); const createEventMutation =
                    useMutation({ mutationFn: async (eventData) =&gt; { return
                    await apiRequest("/api/events", { method: "POST", body:
                    JSON.stringify(eventData), headers: { "Content-Type":
                    "application/json" } }); }, onSuccess: () =&gt; { //
                    Actualiser la liste des √©v√©nements
                    queryClient.invalidateQueries({ queryKey: ["/api/events"]
                    }); } }); const handleSubmit = (data) =&gt; {
                    createEventMutation.mutate(data); }; }
                </div>
            </div>

            <div class="method">
                <h3>üî• M√©thode 2: Avec Firebase Auth Token</h3>
                <p>
                    Pour appeler l'API depuis JavaScript avec Firebase
                    Authentication:
                </p>

                <div class="code-block">
                    import { auth } from 'firebase/auth'; async function
                    callAuthenticatedAPI() { try { // 1. V√©rifier que
                    l'utilisateur est connect√© if (!auth.currentUser) { throw
                    new Error("Utilisateur non connect√©"); } // 2. R√©cup√©rer le
                    token Firebase const token = await
                    auth.currentUser.getIdToken(); // 3. Faire l'appel API avec
                    le token const response = await fetch('/api/events', {
                    method: 'GET', headers: { 'Authorization': `Bearer
                    ${token}`, 'Content-Type': 'application/json' },
                    credentials: 'include' // Important pour les cookies de
                    session }); if (!response.ok) { throw new Error(`HTTP error!
                    status: ${response.status}`); } const events = await
                    response.json(); console.log('√âv√©nements re√ßus:', events);
                    return events; } catch (error) { console.error('Erreur
                    API:', error); throw error; } } // Utilisation
                    callAuthenticatedAPI() .then(events =&gt;
                    console.log(events)) .catch(error =&gt;
                    console.error(error));
                </div>

                <div class="warning">
                    <strong>‚ö†Ô∏è Important:</strong> Cette m√©thode n√©cessite que
                    l'utilisateur soit connect√© via Firebase Auth dans votre
                    application.
                </div>
            </div>

            <div class="method">
                <h3>üç™ M√©thode 3: Avec Session Cookies (Browser uniquement)</h3>
                <p>
                    Apr√®s connexion via email/password, les cookies de session
                    sont automatiquement envoy√©s:
                </p>

                <div class="code-block">
                    async function callWithSession() { try { const response =
                    await fetch('/api/events', { method: 'GET', credentials:
                    'include', // Envoie automatiquement les cookies headers: {
                    'Content-Type': 'application/json' } }); if (response.status
                    === 401) { // L'utilisateur n'est pas connect√© ou la session
                    a expir√© window.location.href = '/login'; return; } if
                    (!response.ok) { throw new Error(`HTTP error! status:
                    ${response.status}`); } const data = await response.json();
                    return data; } catch (error) { console.error('Erreur lors de
                    l\'appel API:', error); throw error; } }
                </div>
            </div>

            <div class="method">
                <h3>üì± M√©thode 4: Depuis une Application Externe</h3>
                <p>
                    Pour appeler votre API depuis une autre application ou site
                    web:
                </p>

                <h4>√âtape 1: Authentification</h4>
                <div class="code-block">
                    // Option A: Connexion par email/password async function
                    login(email, password) { const response = await
                    fetch('https://your-app.replit.app/api/auth/login', {
                    method: 'POST', headers: { 'Content-Type':
                    'application/json' }, credentials: 'include', body:
                    JSON.stringify({ email, password }) }); if (!response.ok) {
                    throw new Error('√âchec de la connexion'); } return await
                    response.json(); } // Option B: Utiliser Firebase Auth dans
                    votre app externe import { initializeApp } from
                    'firebase/app'; import { getAuth, signInWithEmailAndPassword
                    } from 'firebase/auth'; const firebaseConfig = { // Votre
                    config Firebase }; const app =
                    initializeApp(firebaseConfig); const auth = getAuth(app);
                    async function loginWithFirebase(email, password) { const
                    userCredential = await signInWithEmailAndPassword(auth,
                    email, password); return userCredential.user; }
                </div>

                <h4>√âtape 2: Appel API avec authentification</h4>
                <div class="code-block">
                    async function fetchUserEvents() { // M√©thode avec token
                    Firebase const token = await auth.currentUser.getIdToken();
                    const response = await
                    fetch('https://your-app.replit.app/api/events', { headers: {
                    'Authorization': `Bearer ${token}`, 'Content-Type':
                    'application/json' }, credentials: 'include' }); return
                    await response.json(); } // Ou m√©thode avec session (si
                    connect√© via email/password) async function
                    fetchWithSession() { const response = await
                    fetch('https://your-app.replit.app/api/events', {
                    credentials: 'include', headers: { 'Content-Type':
                    'application/json' } }); return await response.json(); }
                </div>
            </div>

            <div class="method">
                <h3>üß™ M√©thode 5: Test avec cURL</h3>
                <p>Pour tester vos APIs avec cURL depuis le terminal:</p>

                <h4>Test API publique:</h4>
                <div class="code-block">
                    curl -X GET "https://your-app.replit.app/api/public/events"
                    \ -H "Content-Type: application/json"
                </div>

                <h4>
                    Test API priv√©e (apr√®s connexion manuelle dans le
                    navigateur):
                </h4>
                <div class="code-block">
                    # 1. Connectez-vous d'abord dans votre navigateur # 2.
                    Copiez les cookies de session depuis les DevTools # 3.
                    Utilisez-les dans cURL: curl -X GET
                    "https://your-app.replit.app/api/events" \ -H "Content-Type:
                    application/json" \ -H "Cookie:
                    connect.sid=s%3A[VOTRE_SESSION_ID]"
                </div>

                <h4>Test avec token Firebase:</h4>
                <div class="code-block">
                    # R√©cup√©rez d'abord un token Firebase depuis votre app #
                    Puis utilisez-le: curl -X GET
                    "https://your-app.replit.app/api/events" \ -H "Content-Type:
                    application/json" \ -H "Authorization: Bearer
                    [VOTRE_FIREBASE_TOKEN]"
                </div>
            </div>

            <div class="success">
                <h4>‚úÖ R√©sum√© des bonnes pratiques:</h4>
                <ul>
                    <li>
                        <strong>Frontend React:</strong> Utilisez
                        <code>useQuery</code> et <code>useMutation</code>
                    </li>
                    <li>
                        <strong>JavaScript externe:</strong> Authentifiez-vous
                        d'abord, puis utilisez tokens ou cookies
                    </li>
                    <li>
                        <strong>Toujours inclure:</strong>
                        <code>credentials: 'include'</code> dans vos requ√™tes
                        fetch
                    </li>
                    <li>
                        <strong>Gestion d'erreurs:</strong> V√©rifiez le statut
                        401 pour rediriger vers login
                    </li>
                    <li>
                        <strong>CORS:</strong> Les APIs priv√©es acceptent les
                        requ√™tes cross-origin avec authentification
                    </li>
                </ul>
            </div>

            <div class="api-endpoint">
                <strong>üîó URL de base de votre API:</strong><br />
                <code id="base-url">https://your-domain.replit.app</code>
            </div>
        </div>

        <script>
            // D√©tecter automatiquement l'URL de base
            const baseUrl = window.location.origin;
            document.getElementById("base-url").textContent = baseUrl;
        </script>
    </body>
</html>
